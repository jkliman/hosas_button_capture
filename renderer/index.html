<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamepad Button Mapper</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1>Gamepad Button Mapper</h1>
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="live">Live Input</button>
        <button class="mode-tab" data-mode="walkthrough">Controller Walkthrough</button>
      </div>
    </header>

    <div class="controller-selector">
      <label for="gamepad-select">Select Controller:</label>
      <select id="gamepad-select">
        <option value="">-- No controllers detected --</option>
      </select>
      <button id="refresh-btn" class="btn btn-secondary">Refresh</button>
    </div>

    <!-- ============ LIVE INPUT MODE ============ -->
    <div class="mode-content" id="live-mode">
      <div class="main-content">
        <!-- Left Panel: Live Input Display -->
        <div class="panel live-panel">
          <div class="panel-header">
            <h2>Live Input</h2>
            <div class="last-pressed" id="last-pressed">
              <span class="label">Last Pressed:</span>
              <span class="value" id="last-pressed-value">None</span>
            </div>
          </div>

          <div class="input-sections">
            <!-- Buttons Section -->
            <div class="input-section">
              <h3>Buttons</h3>
              <div class="button-grid" id="button-grid">
                <p class="no-data">Connect a controller to see buttons</p>
              </div>
            </div>

            <!-- Axes Section -->
            <div class="input-section">
              <h3>Axes</h3>
              <div class="axis-list" id="axis-list">
                <p class="no-data">Connect a controller to see axes</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel: Event Log & Export -->
        <div class="panel log-panel">
          <div class="panel-header">
            <h2>Event Log</h2>
            <div class="log-controls">
              <button id="clear-log-btn" class="btn btn-small">Clear</button>
              <label class="checkbox-label">
                <input type="checkbox" id="log-axes" />
                Log Axes
              </label>
            </div>
          </div>
          <div class="event-log" id="event-log">
            <p class="log-entry log-info">Waiting for controller input...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ WALKTHROUGH MODE ============ -->
    <div class="mode-content hidden" id="walkthrough-mode">
      <!-- Controller Selection for Walkthrough -->
      <div class="walkthrough-setup" id="walkthrough-setup">
        <h2>Select Controller Type</h2>
        <p class="subtitle">Choose your controller to start the mapping walkthrough</p>

        <!-- Create Custom Controller Card -->
        <div class="create-custom-section">
          <div class="create-custom-card" id="create-custom-card">
            <div class="create-custom-icon">+</div>
            <div class="card-name">Create Custom Controller</div>
            <div class="card-description">Upload an image and define your own buttons</div>
          </div>
        </div>

        <div class="controller-type-grid" id="controller-type-grid">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Custom Controller Creator -->
      <div class="custom-creator hidden" id="custom-creator">
        <div class="custom-creator-layout">
          <!-- Left: Image Upload and Button Placement -->
          <div class="custom-creator-image-panel">
            <div class="custom-image-container" id="custom-image-container">
              <div class="upload-placeholder" id="upload-placeholder">
                <div class="upload-icon">üì∑</div>
                <p>Click to upload controller image</p>
                <p class="upload-hint">Supports PNG, JPG, WebP</p>
                <input type="file" id="custom-image-input" accept="image/*" hidden>
              </div>
              <img id="custom-image" src="" alt="Custom Controller" class="hidden">
              <div class="custom-overlay" id="custom-overlay"></div>
            </div>
            <div class="custom-image-actions">
              <button id="change-image-btn" class="btn btn-secondary btn-small hidden">Change Image</button>
              <button id="clear-controls-btn" class="btn btn-secondary btn-small hidden">Clear All Controls</button>
            </div>
          </div>

          <!-- Right: Control Creation Panel -->
          <div class="custom-creator-panel">
            <div class="custom-creator-header">
              <h2>Create Custom Controller</h2>
            </div>

            <div class="custom-form">
              <div class="form-group">
                <label for="custom-controller-name">Controller Name</label>
                <input type="text" id="custom-controller-name" placeholder="e.g., My Custom HOTAS">
              </div>
              <div class="form-group">
                <label for="custom-controller-desc">Description</label>
                <input type="text" id="custom-controller-desc" placeholder="e.g., Custom flight stick setup">
              </div>
            </div>

            <div class="custom-instructions">
              <h3>Adding Controls</h3>
              <ol>
                <li>Upload a controller image</li>
                <li>Click on the image to place a control</li>
                <li>Enter a name for the control</li>
                <li>Select button or axis type</li>
                <li>Drag to reposition, corners to resize</li>
              </ol>
            </div>

            <div class="custom-control-form hidden" id="custom-control-form">
              <h3>New Control</h3>
              <div class="form-group">
                <label for="control-label">Control Name</label>
                <input type="text" id="control-label" placeholder="e.g., Fire Button, Throttle Axis">
              </div>
              <div class="form-group">
                <label>Control Type</label>
                <div class="control-type-btns">
                  <button class="type-btn active" data-type="button">Button</button>
                  <button class="type-btn" data-type="axis">Axis</button>
                </div>
              </div>
              <div class="form-actions">
                <button id="add-control-btn" class="btn btn-primary btn-small">Add Control</button>
                <button id="cancel-control-btn" class="btn btn-secondary btn-small">Cancel</button>
              </div>
            </div>

            <div class="custom-controls-list" id="custom-controls-list">
              <h3>Controls (<span id="controls-count">0</span>)</h3>
              <div class="controls-list-items" id="controls-list-items">
                <p class="no-controls">No controls added yet</p>
              </div>
            </div>

            <div class="custom-creator-actions">
              <button id="custom-cancel-btn" class="btn btn-secondary">Cancel</button>
              <button id="custom-save-btn" class="btn btn-primary" disabled>Save & Start Walkthrough</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Walkthrough -->
      <div class="walkthrough-active hidden" id="walkthrough-active">
        <div class="walkthrough-layout">
          <!-- Left: Controller Image with Highlights -->
          <div class="walkthrough-image-panel">
            <div class="controller-image-container" id="walkthrough-image-container">
              <img id="walkthrough-image" src="" alt="Controller">
              <div class="highlight-overlay" id="highlight-overlay"></div>
            </div>
          </div>

          <!-- Right: Instructions and Progress -->
          <div class="walkthrough-info-panel">
            <div class="walkthrough-header">
              <h2 id="walkthrough-controller-name">Controller</h2>
              <div class="walkthrough-progress">
                <span id="walkthrough-step">1</span> / <span id="walkthrough-total">0</span>
              </div>
            </div>

            <div class="walkthrough-progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="walkthrough-instruction">
              <div class="instruction-type" id="instruction-type">BUTTON</div>
              <h3 class="instruction-label" id="instruction-label">Press this button</h3>
              <p class="instruction-hint">Press the highlighted control on your controller</p>
            </div>

            <div class="walkthrough-detection">
              <div class="detection-status" id="detection-status">
                <span class="status-icon">‚è≥</span>
                <span class="status-text">Waiting for input...</span>
              </div>
              <div class="detected-input" id="detected-input">
                <!-- Shows what was detected -->
              </div>
            </div>

            <div class="walkthrough-mapping" id="current-mapping">
              <!-- Shows current mapped value -->
            </div>

            <!-- Edit Mode Controls (hidden during walkthrough) -->
            <div class="edit-mode-controls hidden" id="edit-mode-controls">
              <div class="edit-control-form">
                <div class="form-group">
                  <label for="edit-control-name">Control Name</label>
                  <input type="text" id="edit-control-name" placeholder="Enter control name">
                </div>
                <div class="edit-control-actions">
                  <button id="rename-control-btn" class="btn btn-small btn-primary">Rename</button>
                  <button id="delete-control-btn" class="btn btn-small btn-danger">Delete</button>
                </div>
              </div>
              <div class="add-control-section">
                <p class="add-hint">Click on the image to add a new control</p>
                <div class="new-control-form hidden" id="new-control-form">
                  <div class="form-group">
                    <label for="new-control-name">New Control Name</label>
                    <input type="text" id="new-control-name" placeholder="e.g., Fire Button">
                  </div>
                  <div class="form-group">
                    <label>Type</label>
                    <div class="edit-type-btns">
                      <button class="edit-type-btn active" data-type="button">Button</button>
                      <button class="edit-type-btn" data-type="axis">Axis</button>
                    </div>
                  </div>
                  <div class="new-control-actions">
                    <button id="confirm-new-control-btn" class="btn btn-small btn-primary">Add</button>
                    <button id="cancel-new-control-btn" class="btn btn-small btn-secondary">Cancel</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="walkthrough-controls">
              <button id="walkthrough-skip" class="btn btn-secondary">Skip</button>
              <button id="walkthrough-back" class="btn btn-secondary">Back</button>
              <button id="walkthrough-next" class="btn btn-primary" disabled>Next</button>
            </div>

            <div class="walkthrough-actions">
              <button id="walkthrough-cancel" class="btn btn-secondary">Cancel</button>
              <button id="walkthrough-finish" class="btn btn-primary hidden">Finish & Export</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Panel: Controller Info & Export -->
    <div class="bottom-panel">
      <div class="controller-info" id="controller-info">
        <div class="info-item">
          <span class="label">Controller:</span>
          <span class="value" id="info-name">Not connected</span>
        </div>
        <div class="info-item">
          <span class="label">ID:</span>
          <span class="value" id="info-id">-</span>
        </div>
        <div class="info-item">
          <span class="label">Buttons:</span>
          <span class="value" id="info-buttons">0</span>
        </div>
        <div class="info-item">
          <span class="label">Axes:</span>
          <span class="value" id="info-axes">0</span>
        </div>
      </div>
      <div class="export-controls">
        <button id="export-btn" class="btn btn-primary">Export Full Dump</button>
        <button id="copy-btn" class="btn btn-secondary">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <script src="controllers.js"></script>
  <script src="app.js"></script>
</body>
</html>
